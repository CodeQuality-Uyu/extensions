name: New Package Version

on:
  push:
    branches:
      [
        configuration,
        envirnoment,
        service-collection
      ]

jobs:
  pack_publish:
    name: Pack and Publish
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Package Name
        run: |
          if [ "${{ github.ref_name }}" == "service-collection" ]; then
            PACKAGE_NAME="CQ.Extensions.ServiceCollection"
          elif [ "${{ github.ref_name }}" == "environment" ]; then
            PACKAGE_NAME="CQ.Extensions.Environments"
          elif [ "${{ github.ref_name }}" == "configuration" ]; then
            PACKAGE_NAME="CQ.Extensions.Configuration"
          else
            echo "Unknown branch. Exiting."
            exit 1
          fi
          echo "Package Name: $PACKAGE_NAME"

          echo "package_name=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Install dependencies
        run: dotnet restore $package_name

      - name: Build
        run: dotnet build $package_name --configuration Release /p:Version=${{ github.event.head_commit.message }}

      - name: Pack
        run: dotnet pack $package_name --configuration Release /p:Version=${{ github.event.head_commit.message }} --no-build --output .

      - name: Show files
        run: ls -la

      - name: Publish
        run: dotnet nuget push $package_name.${{ github.event.head_commit.message }}.nupkg --source https://api.nuget.org/v3/index.json --api-key ${NUGET_API_KEY}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
